!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs")):"function"==typeof define&&define.amd?define("signalk-client-angular",["exports","@angular/core","@angular/common/http","rxjs"],e):e(t["signalk-client-angular"]={},t.ng.core,t.ng.common.http,t.rxjs)}(this,function(t,e,a,n){"use strict";var p=function(){function t(){}return t.dotToSlash=function(t){return-1!=t.indexOf(".")?t.split(".").join("/"):t},t.contextToPath=function(t){return("self"==t?"vessels.self":t).split(".").join("/")},t}(),i=function(){function t(){}return t.updates=function(){return{context:null,updates:[]}},t.subscribe=function(){return{context:null,subscribe:[]}},t.unsubscribe=function(){return{context:null,unsubscribe:[]}},t.request=function(){return{requestId:null}},t}(),o=function(){function t(t){this.http=t}return Object.defineProperty(t.prototype,"token",{set:function(t){this._token=t},enumerable:!0,configurable:!0}),t.prototype.getSelf=function(){return this.get("vessels/self")},t.prototype.getSelfId=function(){return this.get("self")},t.prototype.getMeta=function(t,e){return this.get(p.contextToPath(t)+"/"+p.dotToSlash(e)+"/meta")},t.prototype.get=function(t){if(this.endpoint){"/"==t[0]&&(t=t.slice(1));var e=this.endpoint+p.dotToSlash(t);if(this._token){var n=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.get(e,{headers:n})}return this.http.get(e)}},t.prototype.put=function(t,e,n,o){if(this.endpoint){"/"==e[0]&&(e=e.slice(1));var r=this.endpoint+p.contextToPath(t)+"/"+p.dotToSlash(e),i={value:{}};if(void 0===o?i.value=n:i.value[n]=o,this._token){var s=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.put(r,i,{headers:s})}return this.http.put(r,i)}},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:a.HttpClient}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(a.HttpClient))},token:t,providedIn:"root"}),t}(),r=function(){function t(){this._filter=null,this._wsTimeout=2e4,this._connect=new n.Subject,this.onConnect=this._connect.asObservable(),this._close=new n.Subject,this.onClose=this._close.asObservable(),this._error=new n.Subject,this.onError=this._error.asObservable(),this._message=new n.Subject,this.onMessage=this._message.asObservable()}return Object.defineProperty(t.prototype,"token",{set:function(t){this._token=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"connectionTimeout",{get:function(){return this._wsTimeout},set:function(t){this._wsTimeout=t<3e3?3e3:6e4<t?6e4:t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isOpen",{get:function(){return!(!this.ws||1==this.ws.readyState||3==this.ws.readyState)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filter",{get:function(){return this._filter},set:function(t){t&&-1!=t.indexOf("self")?this._filter=this.selfId?this.selfId:null:this._filter=t},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.ws&&(this.ws.close(),this.ws=null)},t.prototype.open=function(t,e,n){var o=this;if(t=t||this.endpoint){var r=-1==t.indexOf("?")?"?":"&";e&&(t+=r+"subscribe="+e),(this._token||n)&&(t+=(e?"&":"?")+"token="+(this._token||n)),this.close(),this.ws=new WebSocket(t),setTimeout(function(){o.ws&&1!=o.ws.readyState&&3!=o.ws.readyState&&(console.warn("Connection watchdog expired ("+o._wsTimeout/1e3+" sec): "+o.ws.readyState+"... aborting connection..."),o.close())},this._wsTimeout),this.ws.onopen=function(t){o._connect.next(t)},this.ws.onclose=function(t){o._close.next(t)},this.ws.onerror=function(t){o._error.next(t)},this.ws.onmessage=function(t){var e;if("string"==typeof t.data)try{e=JSON.parse(t.data)}catch(t){return}o.isHello(e)?(o.selfId=e.self,o._message.next(e)):o._filter&&o.isDelta(e)?e.context==o._filter&&o._message.next(e):o._message.next(e)}}},t.prototype.send=function(t){this.ws&&("object"==typeof t&&(t=JSON.stringify(t)),this.ws.send(t))},t.prototype.sendUpdate=function(t,e,n){void 0===t&&(t="self");var o=i.updates();o.context="self"==t?"vessels.self":t,this._token&&(o.token=this._token);var r=[];"string"==typeof e&&r.push({path:e,value:n}),"object"==typeof e&&Array.isArray(e)&&(r=e),o.updates.push({values:r}),this.send(o)},t.prototype.subscribe=function(t,e,n){void 0===t&&(t="*"),void 0===e&&(e="*");var o=i.subscribe();if(o.context="self"==t?"vessels.self":t,this._token&&(o.token=this._token),"object"==typeof e&&Array.isArray(e)&&(o.subscribe=e),"string"==typeof e){var r={};r.path=e,n&&"object"==typeof n&&(n.period&&(r.period=n.period),n.minPeriod&&(r.minPeriod=n.period),!n.format||"delta"!=n.format&&"full"!=n.format||(r.format=n.format),!n.policy||"instant"!=n.policy&&"ideal"!=n.policy&&"fixed"!=n.policy||(r.policy=n.policy)),o.subscribe.push(r)}this.send(o)},t.prototype.unsubscribe=function(t,e){void 0===t&&(t="*"),void 0===e&&(e="*");var n=i.unsubscribe();n.context="self"==t?"vessels.self":t,this._token&&(n.token=this._token),"object"==typeof e&&Array.isArray(e)&&(n.unsubscribe=e),"string"==typeof e&&n.unsubscribe.push({path:e}),this.send(n)},t.prototype.isSelf=function(t){return t.context==this.selfId},t.prototype.isDelta=function(t){return"undefined"!=typeof t.context},t.prototype.isHello=function(t){return"undefined"!=typeof t.version},t.prototype.isResponse=function(t){return"undefined"!=typeof t.requestId},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),s=function(){function t(){this._error=new n.Subject,this.onError=this._error.asObservable(),this._message=new n.Subject,this.onMessage=this._message.asObservable()}return t.prototype.ngOnDestroy=function(){this.worker.terminate(),this.worker=undefined},t.prototype.init=function(t){var e=this;if("undefined"==typeof Worker)return!1;this.worker&&this.worker.terminate(),this.worker=new Worker(t),this.worker.onmessage=function(t){e._message.next(t)},this.worker.onerror=function(t){e._error.next(t)}},t.prototype.postMessage=function(t){this.worker&&this.worker.postMessage(t)},t.prototype.terminate=function(){this.worker&&this.worker.terminate()},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),u=function(){function t(t,e,n,o){this.http=t,this.api=e,this.stream=n,this.worker=o,this._version="v1",this.server={endpoints:{},info:{},apiVersions:[]},this.init()}return t.prototype.debug=function(t){e.isDevMode()&&console.log(t)},Object.defineProperty(t.prototype,"version",{get:function(){return parseInt(this._version.slice(1))},set:function(t){var e="v"+t;0==this.server.apiVersions.length?(this._version=e,this.debug("Signal K api version set to: "+e)):(this._version=-1!=this.server.apiVersions.indexOf(e)?e:this._version,this.debug("Signal K api version set request: "+e+", result: "+this._version))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"authToken",{set:function(t){this._token=t,this.api.token=t,this.stream.token=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"message",{get:function(){return i},enumerable:!0,configurable:!0}),t.prototype.ngOnDestroy=function(){this.stream.close()},t.prototype.init=function(t,e,n){void 0===t&&(t="localhost"),void 0===e&&(e=null),void 0===n&&(n=!1),this.hostname=t,this.port=n?(this.protocol="https",e||443):(this.protocol="http",e||80)},t.prototype.hello=function(t,e,n){return void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=!1),this.init(t,e,n),this.get("/signalk")},t.prototype.connect=function(t,o,r){var i=this;return void 0===t&&(t=null),void 0===o&&(o=null),void 0===r&&(r=!1),new Promise(function(e,n){i.debug("Contacting Signal K server........."),i.hello(t,o,r).subscribe(function(t){i.stream&&i.stream.close(),i.processHello(t),i.api.endpoint=i.resolveHttpEndpoint(),i.stream.endpoint=i.resolveStreamEndpoint(),e(!0)},function(t){i.disconnectedFromServer(),n(t)})})},t.prototype.disconnect=function(){this.stream.close(),this.worker.terminate()},t.prototype.connectStream=function(t,o,r,i){var s=this;return void 0===t&&(t=null),void 0===o&&(o=null),void 0===r&&(r=!1),void 0===i&&(i=null),new Promise(function(e,n){s.connect(t,o,r).then(function(){var t=s.resolveStreamEndpoint();t?(s.stream.open(t,i),e(!0)):n(new Error("Server has no advertised Stream endpoints!"))})["catch"](function(t){n(t)})})},t.prototype.connectPlayback=function(n,o,r,i){var s=this;return void 0===n&&(n=null),void 0===o&&(o=null),void 0===r&&(r=!1),new Promise(function(t,e){s.connect(n,o,r).then(function(){s.openPlayback(null,i,s._token),t(!0)})["catch"](function(t){e(t)})})},t.prototype.openStream=function(t,e,n){return void 0===t&&(t=null),this.debug("openStream........."),t||(t=this.resolveStreamEndpoint())?(this.stream.open(t,e,n),!0):new Error("Server has no advertised Stream endpoints!")},t.prototype.openPlayback=function(t,e,n){if(void 0===t&&(t=null),this.debug("openPlayback........."),!t){if(!(t=this.resolveStreamEndpoint()))return new Error("Server has no advertised Stream endpoints!");t=t.replace("stream","playback")}var o,r="";return e&&"object"==typeof e&&(r+=e.startTime?"?startTime="+e.startTime.slice(0,e.startTime.indexOf("."))+"Z":"",r+=e.playbackRate?"&playbackRate="+e.playbackRate:"",o=e.subscribe?e.subscribe:null),this.stream.open(t+r,o,n),!0},t.prototype.processHello=function(t){this.server.endpoints=t.endpoints?t.endpoints:{},this.server.info=t.server?t.server:{},this.server.apiVersions=this.server.endpoints?Object.keys(this.server.endpoints):[],this.debug(this.server.endpoints)},t.prototype.resolveStreamEndpoint=function(){return this.server.endpoints[this._version]&&this.server.endpoints[this._version]["signalk-ws"]?(this.debug("Connecting endpoint version: "+this._version),""+this.server.endpoints[this._version]["signalk-ws"]):this.server.endpoints.v1&&this.server.endpoints.v1["signalk-ws"]?(this.debug("Connection falling back to: v1"),""+this.server.endpoints.v1["signalk-ws"]):null},t.prototype.resolveHttpEndpoint=function(){var t;if(this.server.endpoints[this._version])t=this.server.endpoints[this._version]["signalk-http"]?""+this.server.endpoints[this._version]["signalk-http"]:""+this.server.endpoints.v1["signalk-http"];else{this.debug("No current connection http endpoint service! Use connect() to establish a connection.")}return t},t.prototype.disconnectedFromServer=function(){this.server.endpoints={},this.server.info={},this.server.apiVersions=[]},t.prototype.get=function(t){var e=this.protocol+"://"+this.hostname+":"+this.port+p.dotToSlash(t);if(this.debug("get "+e),this._token){var n=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.get(e,{headers:n})}return this.http.get(e)},t.prototype.put=function(t,e){var n=this.protocol+"://"+this.hostname+":"+this.port+p.dotToSlash(t);if(this.debug("put "+n),this._token){var o=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.put(n,{headers:o})}return this.http.put(n,e)},t.prototype.post=function(t,e){var n=this.protocol+"://"+this.hostname+":"+this.port+p.dotToSlash(t);if(this.debug("post "+n),this._token){var o=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.post(n,{headers:o})}return this.http.post(n,e)},t.prototype.login=function(t,e){var n=(new a.HttpHeaders).set("Content-Type","application/json");return this.http.post(this.protocol+"://"+this.hostname+":"+this.port+"/signalk/"+this._version+"/auth/login",{username:t,password:e},{headers:n})},t.prototype.logout=function(){var t=this.protocol+"://"+this.hostname+":"+this.port+"/signalk/"+this._version+"/auth/logout";if(this._token){var e=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.put(t,null,{headers:e})}return this.http.put(t,null)},t.prototype.snapshot=function(t,e){if(e){e=e.slice(0,e.indexOf("."))+"Z";var n=this.resolveHttpEndpoint();if(n){if(n=""+n.replace("api","snapshot")+p.contextToPath(t)+"?time="+e,this._token){var o=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.get(n,{headers:o})}return this.http.get(n)}}},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:a.HttpClient},{type:o},{type:r},{type:s}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(a.HttpClient),e.inject(o),e.inject(r),e.inject(s))},token:t,providedIn:"root"}),t}(),c=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{imports:[a.HttpClientModule],declarations:[],exports:[],entryComponents:[],providers:[]}]}],t}();t.SignalKClientModule=c,t.SignalKClient=u,t.ɵa=o,t.ɵb=r,t.ɵc=s,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=signalk-client-angular.umd.min.js.map