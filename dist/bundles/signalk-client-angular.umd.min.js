!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs")):"function"==typeof define&&define.amd?define("signalk-client-angular",["exports","@angular/core","@angular/common/http","rxjs"],e):e(t["signalk-client-angular"]={},t.ng.core,t.ng.common.http,t.rxjs)}(this,function(t,s,a,e){"use strict";var i=function(){function t(t){this.http=t,this._version="v1",this._filter=null,this._wsTimeout=2e4,this._authType={never:0,forwrite:1,always:2},this.server={authRequired:0,endpoints:{},info:{},apiVersions:[],ws:{self:null,roles:{}}},this._connect=new e.Subject,this.onConnect=this._connect.asObservable(),this._close=new e.Subject,this.onClose=this._close.asObservable(),this._error=new e.Subject,this.onError=this._error.asObservable(),this._message=new e.Subject,this.onMessage=this._message.asObservable(),this.init()}return t.prototype.debug=function(t){s.isDevMode()&&console.log(t)},Object.defineProperty(t.prototype,"version",{get:function(){return parseInt(this._version.slice(1))},set:function(t){var e="v"+t;0==this.server.apiVersions.length?(this._version=e,this.debug("Signal K api version set to: "+e)):(this._version=-1!=this.server.apiVersions.indexOf(e)?e:this._version,this.debug("Signal K api version set request: "+e+", result: "+this._version))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"apiVersions",{get:function(){return this.server.apiVersions},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isConnected",{get:function(){return!!this.ws},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"authRequired",{get:function(){return this.server.authRequired},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"authToken",{set:function(t){this._token=t},enumerable:!0,configurable:!0}),t.prototype.login=function(t,e){var i=(new a.HttpHeaders).set("Content-Type","application/json");return this.http.post(this.protocol+"://"+this.hostname+":"+this.port+"/signalk/"+this._version+"/auth/login",{username:t,password:e},{headers:i})},t.prototype.logout=function(){var t=this.protocol+"://"+this.hostname+":"+this.port+"/signalk/"+this._version+"/auth/logout";return this._token&&(t+="&token="+this._token),this.http.put(t,{})},Object.defineProperty(t.prototype,"connectionTimeout",{get:function(){return this._wsTimeout},set:function(t){this._wsTimeout=t<3e3?3e3:6e4<t?6e4:t},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=!1),s.isDevMode()?(t=t||"192.168.99.100",e=e||3e3):t=t||"localhost",this.hostname=t,this.port=i?(this.protocol="https",this.wsProtocol="wss",e||443):(this.protocol="http",this.wsProtocol="ws",e||80)},t.prototype.processHello=function(t){this.server.endpoints=t.endpoints?t.endpoints:{},this.server.info=t.server?t.server:{},this.server.apiVersions=this.server.endpoints?Object.keys(this.server.endpoints):[],this.server.authRequired=t.authenticationRequired?this._authType[t.authenticationRequired]:0,this.debug(this.server.endpoints)},t.prototype.getStreamUrl=function(){return this.server.endpoints[this._version]&&this.server.endpoints[this._version]["signalk-ws"]?(this.debug("Connecting endpoint version: "+this._version),""+this.server.endpoints[this._version]["signalk-ws"]):this.server.endpoints.v1&&this.server.endpoints.v1["signalk-ws"]?(this.debug("Connection falling back to: v1"),""+this.server.endpoints.v1["signalk-ws"]):null},t.prototype.hello=function(t,e,i){return void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=!1),this.init(t,e,i),this.get("/signalk")},t.prototype.connect=function(t,e,i,s){var n=this;void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=!1),void 0===s&&(s=null),this.debug("Contacting Signal K server........."),this.hello(t,e,i).subscribe(function(t){n.processHello(t);var e=n.getStreamUrl();e?(s&&(e+="?subscribe="+s),n._token&&(e+="&token="+n._token),n.debug("Connecting to "+e),n.connectDeltaByUrl(e)):n._error.next(new Error("No Signal K endpoints found!"))},function(t){return n.server.endpoints={},n.server.info={},n.server.apiVersions=[],n._error.next(t)})},t.prototype.connectDelta=function(t,e,i,s){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=!1),void 0===s&&(s=null),this.debug("ConnectDelta........."),this.init(t,e,i);var n=this.wsProtocol+"://"+this.hostname+":"+this.port+"/signalk/"+this._version+"/stream";s&&(n+="?subscribe="+s),this._token&&(n+="&token="+this._token),this.debug("Connecting to delta stream at "+n),this.connectDeltaByUrl(n)},t.prototype.playback=function(t,e,i,s){var n=this;void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=!1),this.debug("Contacting Signal K server........."),this.hello(t,e,i).subscribe(function(t){n.processHello(t);var e=n.getStreamUrl();e?(e=e.replace("stream","playback"),"string"==typeof s&&(e+="?subscribe="+s),"object"==typeof s&&(e+="?subscribe="+n.parsePlaybackOptions(s)),n._token&&(e+="&token="+n._token),n.debug("Connecting to "+e),n.connectDeltaByUrl(e)):n._error.next(new Error("No Signal K endpoints found!"))},function(t){return n.server.endpoints={},n.server.info={},n.server.apiVersions=[],n._error.next(t)})},t.prototype.connectPlayback=function(t,e,i,s){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=!1),this.debug("Playback........."),this.init(t,e,i);var n=this.wsProtocol+"://"+this.hostname+":"+this.port+"/signalk/"+this._version+"/playback";"string"==typeof s&&(n+="?subscribe="+s),"object"==typeof s&&(n+="?subscribe="+this.parsePlaybackOptions(s)),this._token&&(n+="&token="+this._token),this.debug("Connecting to playback stream at "+n),this.connectDeltaByUrl(n)},t.prototype.parsePlaybackOptions=function(t){var e="";(t.context&&(e+=t.context),t.startTime)&&(e+="&startTime="+(t.startTime.slice(0,t.startTime.indexOf("."))+"Z"));return t.playbackRate&&(e+="&playbackRate="+t.playbackRate),e},t.prototype.connectDeltaByUrl=function(t){var i=this;this.server.authRequired&&!this._token&&(this.debug("Auth Required and NO token available!"),this._error.next(new Error("Auth Required and NO token available!"))),this.ws&&this.disconnect(),this.ws=new WebSocket(t),setTimeout(function(){i.ws&&1!=i.ws.readyState&&3!=i.ws.readyState&&(i.debug("Connection watchdog expired ("+i._wsTimeout/1e3+" sec): "+i.ws.readyState+"... aborting connection..."),i.disconnect())},this._wsTimeout),this.ws.onopen=function(t){i.debug("ws.open"),i._connect.next(t)},this.ws.onclose=function(t){i.debug("ws.close"),i._close.next(t)},this.ws.onerror=function(t){i.debug("ws.error"),i._error.next(t)},this.ws.onmessage=function(t){var e;if("string"==typeof t.data)try{e=JSON.parse(t.data)}catch(t){return}i.isHello(e)&&(i.server.ws.roles=e.roles,i.server.ws.self=e.self),i._filter&&i.isDelta(e)?e.context==i._filter&&i._message.next(e):i._message.next(e)}},t.prototype.disconnect=function(){this.ws&&(this.ws.close(),this.ws=null,this.server.ws={self:null,roles:{}})},t.prototype.send=function(t){this.ws&&("object"==typeof t&&(t=JSON.stringify(t)),this.ws.send(t))},t.prototype.sendUpdate=function(t,e,i){void 0===t&&(t="self");var s={context:"self"==t?"vessels.self":t,updates:[{values:[{path:e,value:i}]}]};this.debug("sending update: "+JSON.stringify(s)),this.send(s)},t.prototype.subscribe=function(t,e){void 0===t&&(t="*"),void 0===e&&(e="*");for(var i=[],s=2;s<arguments.length;s++)i[s-2]=arguments[s];var n={context:"self"==t?"vessels.self":t,subscribe:[]},o={};for(var r in o.path=e,i)switch(r){case"0":isNaN(i[r])||(o.period=parseInt(i[r]));break;case"1":"delta"!=i[r]&&"full"!=i[r]||(o.format=i[r]);break;case"2":"instant"!=i[r]&&"ideal"!=i[r]&&"fixed"!=i[r]||(o.policy=i[r]);break;case"3":"instant"==o.policy&&(isNaN(i[r])||(o.minPeriod=parseInt(i[r])))}n.subscribe.push(o),this.send(n)},t.prototype.unsubscribe=function(t,e){void 0===t&&(t="*"),void 0===e&&(e="*"),t="self"==t?"vessels.self":t,this.send({context:t,unsubscribe:[{path:e}]})},t.prototype.isDelta=function(t){return"undefined"!=typeof t.context},t.prototype.isHello=function(t){return"undefined"!=typeof t.version},Object.defineProperty(t.prototype,"filter",{get:function(){return this._filter},set:function(t){var e=this;if(t)if(-1!=t.indexOf("self"))this.server.ws.self?this._filter=this.server.ws.self:this.getSelfId().subscribe(function(t){e._filter=t});else{var i=RegExp("^urn:mrn:signalk:uuid:[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-4[0-9A-Fa-f]{3}-[89ABab][0-9A-Fa-f]{3}-[0-9A-Fa-f]{12}$");-1!=t.indexOf("vessels.")&&(t=t.slice(t.indexOf(".")+1)),i.test(t)&&(this._filter="vessels."+t)}else this._filter=null},enumerable:!0,configurable:!0}),t.prototype.raiseAlarm=function(t,e,i){void 0===t&&(t="self"),this.sendUpdate(t,"notifications."+e,i)},t.prototype.clearAlarm=function(t,e){void 0===t&&(t="self"),this.sendUpdate(t,"notifications."+e,null)},t.prototype.getSelf=function(){return this.apiGet("vessels/self")},t.prototype.getSelfId=function(){return this.apiGet("self")},t.prototype.getMeta=function(t,e){return this.apiGet(this.contextToPath(t)+"/"+this.dotToSlash(e)+"/meta")},t.prototype.apiGet=function(t){var e=this.resolveHttpEndpoint();if(e){if("/"==t[0]&&(t=t.slice(1)),e+=this.dotToSlash(t),this.debug("apiGet "+e),this._token){var i=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.get(e,{headers:i})}return this.server.authRequired&&(this.debug("Auth Required and NO token available!"),this._error.next(new Error("Auth Required and NO token available!"))),this.http.get(e)}},t.prototype.apiPut=function(t,e,i,s){var n=this.resolveHttpEndpoint();if(n){"/"==e[0]&&(e=e.slice(1)),n+=this.contextToPath(t)+"/"+this.dotToSlash(e);var o={value:{}};if(void 0===s?o.value=i:o.value[i]=s,this.debug("apiPut "+n),this.debug(JSON.stringify(o)),this._token){var r=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.put(n,o,{headers:r})}return this.server.authRequired&&(this.debug("Auth Required and NO token available!"),this._error.next(new Error("Auth Required and NO token available!"))),this.http.put(n,o)}},t.prototype.snapshot=function(t,e){var i=this.resolveHttpEndpoint();if(i&&e){if(e=e.slice(0,e.indexOf("."))+"Z",i="/signalk/"+this._version+"/snapshot/"+this.contextToPath(t)+"?time="+e,this.debug("snapshot "+i),this._token){var s=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.get(i,{headers:s})}return this.server.authRequired&&(this.debug("Auth Required and NO token available!"),this._error.next(new Error("Auth Required and NO token available!"))),this.http.get(i)}},t.prototype.get=function(t){var e=this.protocol+"://"+this.hostname+":"+this.port+this.dotToSlash(t);if(this.debug("get "+e),this._token){var i=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.get(e,{headers:i})}return this.server.authRequired&&(this.debug("Auth Required and NO token available!"),this._error.next(new Error("Auth Required and NO token available!"))),this.http.get(e)},t.prototype.put=function(t,e){var i=this.protocol+"://"+this.hostname+":"+this.port+this.dotToSlash(t);if(this.debug("put "+i),this._token){var s=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.put(i,{headers:s})}return this.server.authRequired&&(this.debug("Auth Required and NO token available!"),this._error.next(new Error("Auth Required and NO token available!"))),this.http.put(i,e)},t.prototype.post=function(t,e){var i=this.protocol+"://"+this.hostname+":"+this.port+this.dotToSlash(t);if(this.debug("post "+i),this._token){var s=new a.HttpHeaders({Authorization:"JWT "+this._token});return this.http.post(i,{headers:s})}return this.server.authRequired&&(this.debug("Auth Required and NO token available!"),this._error.next(new Error("Auth Required and NO token available!"))),this.http.post(i,e)},t.prototype.resolveHttpEndpoint=function(){var t;if(this.server.endpoints[this._version])t=this.server.endpoints[this._version]["signalk-http"]?""+this.server.endpoints[this._version]["signalk-http"]:""+this.server.endpoints.v1["signalk-http"];else{var e="No current connection http endpoint service! Use connect() to establish a connection.";this.debug(e),this._error.next(new Error(e))}return t},t.prototype.contextToPath=function(t){return("self"==t?"vessels.self":t).split(".").join("/")},t.prototype.dotToSlash=function(t){return-1!=t.indexOf(".")?t.split(".").join("/"):t},t.prototype.slashToDot=function(t){return-1!=t.indexOf("/")?t.split("/").join("."):t},t.decorators=[{type:s.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:a.HttpClient}]},t.ngInjectableDef=s.defineInjectable({factory:function(){return new t(s.inject(a.HttpClient))},token:t,providedIn:"root"}),t}(),n={normal:"normal",alert:"alert",warn:"warn",alarm:"alarm",emergency:"emergency"},o={visual:"visual",sound:"sound"},r=function h(t){void 0===t&&(t=null),this.state=n.normal,this.method=[o.visual,o.sound],this.message=t};t.SignalKClient=i,t.AlarmState=n,t.AlarmMethod=o,t.Alarm=r,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=signalk-client-angular.umd.min.js.map