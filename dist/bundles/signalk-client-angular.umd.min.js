!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs")):"function"==typeof define&&define.amd?define("signalk-client-angular",["exports","@angular/core","@angular/common/http","rxjs"],e):e((t=t||self)["signalk-client-angular"]={},t.ng.core,t.ng.common.http,t.rxjs)}(this,function(t,e,n,o){"use strict";var i=function(){function t(){this.limitUI04=this.maxFromBits(4),this.limitUI06=this.maxFromBits(6),this.limitUI08=this.maxFromBits(8),this.limitUI12=this.maxFromBits(12),this.limitUI14=this.maxFromBits(14),this.limitUI16=this.maxFromBits(16),this.limitUI32=this.maxFromBits(32),this.limitUI40=this.maxFromBits(40),this.limitUI48=this.maxFromBits(48),this.create()}return t.prototype.toString=function(){return this.hex},t.prototype.toURN=function(){return"urn:uuid:"+this.hex},t.prototype.toSignalK=function(){return"urn:mrn:signalk:uuid:"+this.hex},t.prototype.toBytes=function(){for(var t=this.hex.split("-"),e=[],n=0,o=0;o<t.length;o++)for(var i=0;i<t[o].length;i+=2)e[n++]=parseInt(t[o].substr(i,2),16);return e},t.prototype.maxFromBits=function(t){return Math.pow(2,t)},t.prototype.getRandomInt=function(t,e){return Math.floor(Math.random()*(e-t+1))+t},t.prototype.randomUI04=function(){return this.getRandomInt(0,this.limitUI04-1)},t.prototype.randomUI06=function(){return this.getRandomInt(0,this.limitUI06-1)},t.prototype.randomUI08=function(){return this.getRandomInt(0,this.limitUI08-1)},t.prototype.randomUI12=function(){return this.getRandomInt(0,this.limitUI12-1)},t.prototype.randomUI14=function(){return this.getRandomInt(0,this.limitUI14-1)},t.prototype.randomUI16=function(){return this.getRandomInt(0,this.limitUI16-1)},t.prototype.randomUI32=function(){return this.getRandomInt(0,this.limitUI32-1)},t.prototype.randomUI40=function(){return(0|Math.random()*(1<<30))+(0|1024*Math.random())*(1<<30)},t.prototype.randomUI48=function(){return(0|Math.random()*(1<<30))+(0|Math.random()*(1<<18))*(1<<30)},t.prototype.create=function(){this.fromParts(this.randomUI32(),this.randomUI16(),16384|this.randomUI12(),128|this.randomUI06(),this.randomUI08(),this.randomUI48())},t.prototype.paddedString=function(t,e,n){void 0===n&&(n=null),n=n||"0";for(var o=e-(t=String(t)).length;o>0;o>>>=1,n+=n)1&o&&(t=n+t);return t},t.prototype.fromParts=function(t,e,n,o,i,r){return this.version=n>>12&15,this.hex=this.paddedString(t.toString(16),8)+"-"+this.paddedString(e.toString(16),4)+"-"+this.paddedString(n.toString(16),4)+"-"+this.paddedString(o.toString(16),2)+this.paddedString(i.toString(16),2)+"-"+this.paddedString(r.toString(16),12),this},t}(),r=function(){function t(){}return t.dotToSlash=function(t){var e=t.split("?");return-1!=e[0].indexOf(".")&&(e[0]=e[0].split(".").join("/")),e.join("?")},t.contextToPath=function(t){return("self"==t?"vessels.self":t).split(".").join("/")},t}(),s=function(){function t(){}return t.updates=function(){return{context:null,updates:[]}},t.subscribe=function(){return{context:null,subscribe:[]}},t.unsubscribe=function(){return{context:null,unsubscribe:[]}},t.request=function(){return{requestId:(new i).toString()}},t}(),a=function(){function t(t,e,n,o){this._method=[],this._message="",this._message=void 0!==t?t:"",this._state=void 0!==e?e:p.alarm,n&&this._method.push(h.visual),o&&this._method.push(h.sound)}return Object.defineProperty(t.prototype,"value",{get:function(){return{message:this._message,state:this._state,method:this._method}},enumerable:!0,configurable:!0}),t}(),p={normal:"normal",alert:"alert",warn:"warn",alarm:"alarm",emergency:"emergency"},h={visual:"visual",sound:"sound"},u=function(){function t(t){this.http=t}return Object.defineProperty(t.prototype,"authToken",{set:function(t){this._token=t},enumerable:!0,configurable:!0}),t.prototype.getSelf=function(){return this.get("vessels/self")},t.prototype.getSelfId=function(){return this.get("self")},t.prototype.getMeta=function(t,e){return this.get(r.contextToPath(t)+"/"+r.dotToSlash(e)+"/meta")},t.prototype.get=function(t){if(this.endpoint){"/"==t[0]&&(t=t.slice(1));var e=this.endpoint+r.dotToSlash(t);if(this._token){var o=new n.HttpHeaders({Authorization:"JWT "+this._token});return this.http.get(e,{headers:o})}return this.http.get(e)}},t.prototype.put=function(t,e,o,i){if(this.endpoint){var s,a,p={value:{}};if(void 0===o&&void 0===i)"/"==t[0]&&(t=t.slice(1)),a=r.dotToSlash(t),s="",p.value=e;else if(void 0===i)s=t?r.contextToPath(t):"",a=r.dotToSlash(e),p.value=o;else{s=t?r.contextToPath(t):"";var h=r.dotToSlash(e).split("/");h.push(o),a=h.join("/"),p.value=i}"/"==a[0]&&(a=a.slice(1));var u=a.split("/");if("resources"==u[0]&&(s="",this.server&&"signalk-server-node"==this.server.id)){var c=JSON.parse(JSON.stringify(p.value));p.value={},p.value[u[u.length-1]]=c,a="vessels/self/"+u.slice(0,u.length-1).join("/")}s=s?s+"/":"";var l=this.endpoint+s+r.dotToSlash(a);if(this._token){var d=new n.HttpHeaders({Authorization:"JWT "+this._token});return this.http.put(l,p,{headers:d})}return this.http.put(l,p)}},t.prototype.post=function(t,e){if(this.endpoint){"/"==t[0]&&(t=t.slice(1));var o=""+this.endpoint+r.dotToSlash(t);if(this._token){var i=new n.HttpHeaders({Authorization:"JWT "+this._token});return this.http.post(o,e,{headers:i})}return this.http.post(o,e)}},t.prototype["delete"]=function(t){if(this.endpoint){"/"==t[0]&&(t=t.slice(1));var e=""+this.endpoint+r.dotToSlash(t);if(this._token){var o=new n.HttpHeaders({Authorization:"JWT "+this._token});return this.http["delete"](e,{headers:o})}return this.http["delete"](e)}},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:n.HttpClient}]},t.ngInjectableDef=e.ɵɵdefineInjectable({factory:function(){return new t(e.ɵɵinject(n.HttpClient))},token:t,providedIn:"root"}),t}(),c=function(){function t(){this._filter=null,this._wsTimeout=2e4,this._playbackMode=!1,this._source=null,this._connect=new o.Subject,this.onConnect=this._connect.asObservable(),this._close=new o.Subject,this.onClose=this._close.asObservable(),this._error=new o.Subject,this.onError=this._error.asObservable(),this._message=new o.Subject,this.onMessage=this._message.asObservable()}return Object.defineProperty(t.prototype,"source",{set:function(t){this._source||(this._source={}),this._source.label=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"authToken",{set:function(t){this._token=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"connectionTimeout",{get:function(){return this._wsTimeout},set:function(t){this._wsTimeout=t<3e3?3e3:t>6e4?6e4:t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isOpen",{get:function(){return!(!this.ws||1==this.ws.readyState||3==this.ws.readyState)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filter",{get:function(){return this._filter},set:function(t){t&&-1!=t.indexOf("self")?this._filter=this.selfId?this.selfId:null:this._filter=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"playbackMode",{get:function(){return this._playbackMode},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.ws&&(this.ws.close(),this.ws=null)},t.prototype.open=function(t,e,n){var o=this;if(t=t||this.endpoint){var i=-1==t.indexOf("?")?"?":"&";e&&(t+=i+"subscribe="+e),(this._token||n)&&(t+=(e?"&":"?")+"token="+(this._token||n)),this.close(),this.ws=new WebSocket(t),setTimeout(function(){o.ws&&1!=o.ws.readyState&&3!=o.ws.readyState&&(console.warn("Connection watchdog expired ("+o._wsTimeout/1e3+" sec): "+o.ws.readyState+"... aborting connection..."),o.close())},this._wsTimeout),this.ws.onopen=function(t){o._connect.next(t)},this.ws.onclose=function(t){o._close.next(t)},this.ws.onerror=function(t){o._error.next(t)},this.ws.onmessage=function(t){o.parseOnMessage(t)}}},t.prototype.parseOnMessage=function(t){var e;if("string"==typeof t.data)try{e=JSON.parse(t.data)}catch(t){return}this.isHello(e)?(this.selfId=e.self,this._playbackMode="undefined"!=typeof e.startTime,this._message.next(e)):this.isResponse(e)?("undefined"!=typeof e.login&&"undefined"!=typeof e.login.token&&(this._token=e.login.token),this._message.next(e)):this._filter&&this.isDelta(e)?e.context==this._filter&&this._message.next(e):this._message.next(e)},t.prototype.sendRequest=function(t){if("object"!=typeof t)return null;var e=s.request();return"undefined"==typeof t.login&&this._token&&(e.token=this._token),Object.keys(t).forEach(function(n){e[n]=t[n]}),this.send(e),e.requestId},t.prototype.put=function(t,e,n){var o={context:"self"==t?"vessels.self":t,put:{path:e,value:n}};return this.sendRequest(o)},t.prototype.login=function(t,e){var n={login:{username:t,password:e}};return this.sendRequest(n)},t.prototype.send=function(t){this.ws&&("object"==typeof t&&(t=JSON.stringify(t)),this.ws.send(t))},t.prototype.sendUpdate=function(t,e,n){void 0===t&&(t="self");var o=s.updates();this._token&&(o.token=this._token),o.context="self"==t?"vessels.self":t,this._token&&(o.token=this._token);var i=[];"string"==typeof e&&i.push({path:e,value:n}),"object"==typeof e&&Array.isArray(e)&&(i=e);var r={timestamp:(new Date).toISOString(),values:i};this._source&&(r.source=this._source),o.updates.push(r),this.send(o)},t.prototype.subscribe=function(t,e,n){void 0===t&&(t="*"),void 0===e&&(e="*");var o=s.subscribe();if(this._token&&(o.token=this._token),o.context="self"==t?"vessels.self":t,this._token&&(o.token=this._token),"object"==typeof e&&Array.isArray(e)&&(o.subscribe=e),"string"==typeof e){var i={};i.path=e,n&&"object"==typeof n&&(n.period&&(i.period=n.period),n.minPeriod&&(i.minPeriod=n.period),!n.format||"delta"!=n.format&&"full"!=n.format||(i.format=n.format),!n.policy||"instant"!=n.policy&&"ideal"!=n.policy&&"fixed"!=n.policy||(i.policy=n.policy)),o.subscribe.push(i)}this.send(o)},t.prototype.unsubscribe=function(t,e){void 0===t&&(t="*"),void 0===e&&(e="*");var n=s.unsubscribe();this._token&&(n.token=this._token),n.context="self"==t?"vessels.self":t,this._token&&(n.token=this._token),"object"==typeof e&&Array.isArray(e)&&(n.unsubscribe=e),"string"==typeof e&&n.unsubscribe.push({path:e}),this.send(n)},t.prototype.raiseAlarm=function(t,e,n){var o;void 0===t&&(t="*"),o="string"==typeof e&&-1==e.indexOf("notifications.")?"notifications."+e:e,this.sendUpdate(t,o,n.value)},t.prototype.clearAlarm=function(t,e){void 0===t&&(t="*");var n=-1==e.indexOf("notifications.")?"notifications."+e:e;this.sendUpdate(t,n,null)},t.prototype.isSelf=function(t){return t.context==this.selfId},t.prototype.isDelta=function(t){return"undefined"!=typeof t.context},t.prototype.isHello=function(t){return"undefined"!=typeof t.version&&"undefined"!=typeof t.self},t.prototype.isResponse=function(t){return"undefined"!=typeof t.requestId},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[]},t.ngInjectableDef=e.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),l=function(){function t(t){this.http=t}return t.prototype.ngOnDestroy=function(){},t.prototype.list=function(){return this.http.get(this.endpoint)},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:n.HttpClient}]},t.ngInjectableDef=e.ɵɵdefineInjectable({factory:function(){return new t(e.ɵɵinject(n.HttpClient))},token:t,providedIn:"root"}),t}(),d=function(){function t(){this._error=new o.Subject,this.onError=this._error.asObservable(),this._message=new o.Subject,this.onMessage=this._message.asObservable(),e.isDevMode()&&console.warn("DEPRECATION WARNING: SignalKClient.worker is replaced by the signalk-worker-angular package and will be removed in signalk-client-angular v1.6")}return t.prototype.ngOnDestroy=function(){this.worker.terminate(),this.worker=undefined},t.prototype.init=function(t){var e=this;if("undefined"==typeof Worker)return!1;this.worker&&this.worker.terminate(),this.worker=new Worker(t),this.worker.onmessage=function(t){e._message.next(t)},this.worker.onerror=function(t){e._error.next(t)}},t.prototype.postMessage=function(t){this.worker&&this.worker.postMessage(t)},t.prototype.terminate=function(){this.worker&&this.worker.terminate()},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[]},t.ngInjectableDef=e.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),f=function(){function t(t,e,n,o,i){this.http=t,this.apps=e,this.api=n,this.stream=o,this.worker=i,this._version="v1",this.fallbackEndpoints={endpoints:{v1:{}},server:{id:"fallback"}},this.server={endpoints:{},info:{},apiVersions:[]},this.fallback=!1,this.init()}return t.prototype.debug=function(t){e.isDevMode()&&console.log(t)},Object.defineProperty(t.prototype,"version",{get:function(){return parseInt(this._version.slice(1))},set:function(t){var e="v"+t;0==this.server.apiVersions.length?(this._version=e,this.debug("Signal K api version set to: "+e)):(this._version=-1!=this.server.apiVersions.indexOf(e)?e:this._version,this.debug("Signal K api version set request: "+e+", result: "+this._version))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"authToken",{set:function(t){this._token=t,this.api.authToken=t,this.stream.authToken=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"message",{get:function(){return s},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uuid",{get:function(){return new i},enumerable:!0,configurable:!0}),t.prototype.ngOnDestroy=function(){this.stream.close()},t.prototype.init=function(t,e,n){void 0===t&&(t="localhost"),void 0===e&&(e=null),void 0===n&&(n=!1),this.hostname=t,n?(this.protocol="https",this.port=e||443):(this.protocol="http",this.port=e||80);var o=this.protocol+"://"+this.hostname+":"+this.port;this.fallbackEndpoints.endpoints.v1["signalk-http"]=o+"/signalk/v1/api/",this.fallbackEndpoints.endpoints.v1["signalk-ws"]=o+"/signalk/v1/stream"},t.prototype.hello=function(t,e,n){return void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=!1),this.init(t,e,n),this.get("/signalk")},t.prototype.connect=function(t,e,n){var o=this;return void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=!1),new Promise(function(i,r){o.debug("Contacting Signal K server........."),o.hello(t,e,n).subscribe(function(t){o.stream&&o.stream.close(),o.processHello(t),o.api.endpoint=o.resolveHttpEndpoint(),o.stream.endpoint=o.resolveStreamEndpoint(),i(!0)},function(t){o.fallback?(o.stream&&o.stream.close(),o.processHello(null),o.api.endpoint=o.resolveHttpEndpoint(),o.stream.endpoint=o.resolveStreamEndpoint(),i(!0)):(o.disconnectedFromServer(),r(t))})})},t.prototype.disconnect=function(){this.stream.close(),this.worker.terminate()},t.prototype.connectStream=function(t,e,n,o){var i=this;return void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=!1),void 0===o&&(o=null),new Promise(function(r,s){i.connect(t,e,n).then(function(){var t=i.resolveStreamEndpoint();t?(i.stream.open(t,o),r(!0)):s(new Error("Server has no advertised Stream endpoints!"))})["catch"](function(t){s(t)})})},t.prototype.connectPlayback=function(t,e,n,o){var i=this;return void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=!1),new Promise(function(r,s){i.connect(t,e,n).then(function(){i.openPlayback(null,o,i._token),r(!0)})["catch"](function(t){s(t)})})},t.prototype.openStream=function(t,e,n){return void 0===t&&(t=null),this.debug("openStream........."),t||(t=this.resolveStreamEndpoint())?(this.stream.open(t,e,n),!0):new Error("Server has no advertised Stream endpoints!")},t.prototype.openPlayback=function(t,e,n){if(void 0===t&&(t=null),this.debug("openPlayback........."),!t){if(!(t=this.resolveStreamEndpoint()))return new Error("Server has no advertised Stream endpoints!");t=t.replace("stream","playback")}var o,i="";return e&&"object"==typeof e&&(i+=e.startTime?"?startTime="+e.startTime.slice(0,e.startTime.indexOf("."))+"Z":"",i+=e.playbackRate?"&playbackRate="+e.playbackRate:"",o=e.subscribe?e.subscribe:null),this.stream.open(t+i,o,n),!0},t.prototype.processHello=function(t){this.server.endpoints=t&&t.endpoints?t.endpoints:this.fallbackEndpoints.endpoints,this.server.info=t&&t.server?t.server:this.fallbackEndpoints.server,this.server.apiVersions=this.server.endpoints?Object.keys(this.server.endpoints):[],this.debug(this.server.endpoints),this.api.server=this.server.info,this.apps.endpoint=this.resolveAppsEndpoint()},t.prototype.resolveAppsEndpoint=function(){return"signalk-server-node"==this.server.info.id?this.protocol+"://"+this.hostname+":"+this.port+"/webapps":this.resolveHttpEndpoint().replace("api","apps")},t.prototype.resolveStreamEndpoint=function(){return this.server.endpoints[this._version]&&this.server.endpoints[this._version]["signalk-ws"]?(this.debug("Connecting endpoint version: "+this._version),""+this.server.endpoints[this._version]["signalk-ws"]):this.server.endpoints.v1&&this.server.endpoints.v1["signalk-ws"]?(this.debug("Connection falling back to: v1"),""+this.server.endpoints.v1["signalk-ws"]):null},t.prototype.resolveHttpEndpoint=function(){var t;if(this.server.endpoints[this._version])t=this.server.endpoints[this._version]["signalk-http"]?""+this.server.endpoints[this._version]["signalk-http"]:""+this.server.endpoints.v1["signalk-http"];else{this.debug("No current connection http endpoint service! Use connect() to establish a connection.")}return t},t.prototype.disconnectedFromServer=function(){this.server.endpoints={},this.server.info={},this.server.apiVersions=[]},t.prototype.get=function(t){var e=this.protocol+"://"+this.hostname+":"+this.port+r.dotToSlash(t);if(this.debug("get "+e),this._token){var o=new n.HttpHeaders({Authorization:"JWT "+this._token});return this.http.get(e,{headers:o})}return this.http.get(e)},t.prototype.put=function(t,e){var o=this.protocol+"://"+this.hostname+":"+this.port+r.dotToSlash(t);if(this.debug("put "+o),this._token){var i=new n.HttpHeaders({Authorization:"JWT "+this._token});return this.http.put(o,{headers:i})}return this.http.put(o,e)},t.prototype.post=function(t,e){var o=this.protocol+"://"+this.hostname+":"+this.port+r.dotToSlash(t);if(this.debug("post "+o),this._token){var i=new n.HttpHeaders({Authorization:"JWT "+this._token});return this.http.post(o,{headers:i})}return this.http.post(o,e)},t.prototype.login=function(t,e){var o=(new n.HttpHeaders).set("Content-Type","application/json");return this.http.post(this.protocol+"://"+this.hostname+":"+this.port+"/signalk/"+this._version+"/auth/login",{username:t,password:e},{headers:o})},t.prototype.logout=function(){var t=this.protocol+"://"+this.hostname+":"+this.port+"/signalk/"+this._version+"/auth/logout";if(this._token){var e=new n.HttpHeaders({Authorization:"JWT "+this._token});return this.http.put(t,null,{headers:e})}return this.http.put(t,null)},t.prototype.snapshot=function(t,e){if(e){e=e.slice(0,e.indexOf("."))+"Z";var o=this.resolveHttpEndpoint();if(o){if(o=""+o.replace("api","snapshot")+r.contextToPath(t)+"?time="+e,this._token){var i=new n.HttpHeaders({Authorization:"JWT "+this._token});return this.http.get(o,{headers:i})}return this.http.get(o)}}},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:n.HttpClient},{type:l},{type:u},{type:c},{type:d}]},t.ngInjectableDef=e.ɵɵdefineInjectable({factory:function(){return new t(e.ɵɵinject(n.HttpClient),e.ɵɵinject(l),e.ɵɵinject(u),e.ɵɵinject(c),e.ɵɵinject(d))},token:t,providedIn:"root"}),t}(),v=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{imports:[n.HttpClientModule],declarations:[],exports:[],entryComponents:[],providers:[]}]}],t}();t.Alarm=a,t.AlarmMethod=h,t.AlarmState=p,t.AlarmType={mob:"notifications.mob",fire:"notifications.fire",sinking:"notifications.sinking",flooding:"notifications.flooding",collision:"notifications.collision",grounding:"notifications.grounding",listing:"notifications.listing",adrift:"notifications.adrift",piracy:"notifications.piracy",abandon:"notifications.abandon"},t.Message=s,t.Path=r,t.SignalKApps=l,t.SignalKClient=f,t.SignalKClientModule=v,t.SignalKHttp=u,t.SignalKStream=c,t.ɵa=d,t.ɵb=i,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=signalk-client-angular.umd.min.js.map